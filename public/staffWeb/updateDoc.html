<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>View</title>
</head>

<body>

    <div>
        GetValue id
        <div id='result_ID'></div>

        <ul id='result_id'>
        </ul>
    </div>

    <h1>Update document file</h1>
    <label for="topic">Topic name</label>
    <input type="text" id="topicName_" name="topicName_" placeholder="Topic name ...">
    <br>
    <label for="description">Content</label>
    <textarea id="fileDescription_" name="fileDescription_"></textarea>
    <br>
    <label for="namebox">File name</label>
    <input type="text" id="fileName_" name="fileName_" placeholder="File name ...">
    <br>
    <label for="file" button type="button" class="btn btn-default " id="selectfile_">Select file</label>
    <button id="upload">Upload File</button>

    <h3 id="fileOldName"></h3>
    <h5 id="upProgress"></h5>


    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-analytics.js"></script>
    <script src='https://www.gstatic.com/firebasejs/3.2.1/firebase.js'></script>
    <script> //--------ConnectFirebase--------
        var firebaseConfig = {
            apiKey: "AIzaSyD_PU5bw4-vNEYL5ew7sow970gTu-ZtLG4",
            authDomain: "modloans-f8d62.firebaseapp.com",
            projectId: "modloans-f8d62",
            storageBucket: "modloans-f8d62.appspot.com",
            messagingSenderId: "398266070886",
            appId: "1:398266070886:web:d684c75954cb090ae3faa7",
            measurementId: "G-61MQ0SD6LJ",
            databaseURL: "https://modloans-f8d62-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);

        //--------------------------
        document.getElementById('result_ID').innerHTML = localStorage.getItem('VALUE');
        console.log(localStorage.getItem('VALUE'));

        //var xxx = document.getElementById('result_ID').value;

        //-----------------

        database = firebase.database();
        var Ref = database.ref('Files');
        Ref.on('value', gotData);
        function gotData(data) {
            var a = localStorage.getItem('VALUE');
            var Files = data.val();
            var id = Files[a].Date;
            var topic = Files[a].TopicName;
            var description = Files[a].Description;
            var fileName = Files[a].NameFile;
            var linkFile = Files[a].LinkFile;
            console.log(topic, description, fileName);
            var li = document.createElement('li');
            li.innerHTML =
                '<p>topic : ' + topic + '<br>' +
                'Content : ' + description + '<br>' +
                'filename : ' + fileName + '<br>' +
                'Link file : <a target = "_blank" href=' + linkFile + '>Click link here.<br></p>';
            document.getElementById('result_id').appendChild(li);
        


        //--------------------------
        var fileName, fileURL, fileDescription;
        var files = [];
        var reader = new FileReader();
        //--------------------------
        function parm() {
            topicName = document.getElementById('topicName_').value;
            fileName = document.getElementById('fileName_').value;
            fileDescription = document.getElementById('fileDescription_').value;
        }

        //---------------------------selectFile----------------------------
        document.getElementById('selectfile_').onclick = function (e) {
            var input = document.createElement('input');
            input.type = 'file';
            input.onchange = e => {
                files = e.target.files;
                reader = new FileReader();
                reader.onload = function () {
                    //document.getElementById('myFile').src = reader.result;
                    document.getElementById('fileOldName').innerHTML = '<b>Your file is : </b>' + files[0].name;
                }
                reader.readAsDataURL(files[0]);
            }
            input.click();
        }

        //-----------------uploadFile and createFileName------------------
        document.getElementById('upload').onclick = function () {
            parm();
            if (fileName == "" || topicName == "") {
                window.alert("Please enter Topic name and File name");
                console.log("Please enter Topic name and File name");
            } else {
                console.log("Up loadfile. . .");
                var uploadTask = firebase.storage().ref('File/' + fileName).put(files[0]);

                //---show % upload on log---
                uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED,
                    function (snapshot) {
                        var percent = snapshot.bytesTransferred / snapshot.totalBytes * 100;
                        console.log(percent + "% done");
                        document.getElementById('upProgress').innerHTML = 'Upload ' + percent + ' %';
                    },
                    function (error) {
                        console.log('Error in saving file.');
                    },
                    function () {
                        uploadTask.snapshot.ref.getDownloadURL().then(function (URL) {
                            fileURL = URL;
                            // var now = new Date().getTime();

                            firebase.database().ref('File/' + id).set({
                                Date: id,
                                TopicName: topicName,
                                NameFile: fileName,
                                LinkFile: fileURL,
                                Description: fileDescription
                            }).then(() => {
                                window.alert("Add file successfully.");
                                console.log('Add file successfully');
                                location.reload();
                            });
                        })
                    });
            }
        }
		}
    </script>


</body>

</html>